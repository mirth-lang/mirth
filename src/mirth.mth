module(mirth)

import(prelude)
import(platform.posix)
import(data.path)
import(data.str)
import(mirth.data.error)
import(mirth.data.prim)
import(mirth.data.type)
import(mirth.input)
import(mirth.lexer)
import(mirth.codegen)
import(mirth.elab)

def(init!, --,
    init-errors!
    init-paths!
    init-prims!
    init-types!
    init-elab!)

########
# Main #
########

def(compile!, Path --,
    "Compiling " str-trace!
    dup Path->Str str-trace-ln!

    run-lexer!

    # show-names-table!
    # show-tokens!

    "Building." str-trace-ln!

    elab-module! drop
    typecheck-everything!

    num-errors @ 0 > if(
        num-errors @ int-trace!
        " errors." str-trace-ln!
        1 posix-exit!,

        "Done." str-trace-ln!
    ))

def(main, --,
    init!

    # argc int-trace-ln!
    # 0 while(dup argc <,
    #     dup argv ptr@@ str-trace-ln!
    #     1+
    # ) drop

    expect!(argc 2 ==, "expected one argument")
    1 argv ptr@@ str-copy-cstr Str->Path compile!)

#########
# Build #
#########

target-c99("mirth.c", main)
