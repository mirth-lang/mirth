module(mirth)

import(prelude)
import(mirth/input)
import(mirth/lexer)
import(mirth/codegen)
import(mirth/elab)

import(mirth/data/path)
import(mirth/data/prim)
import(mirth/data/type)

def(init!, +IO,
    init-paths!
    init-prims!
    init-types!)

########
# Main #
########

def(compile!, Path -- +IO,
    "Compiling " caststr str-trace!
    dup Path->Str str-trace-ln!

    run-lexer!

    # show-names-table!
    # show-tokens!

    "Building." caststr str-trace-ln!

    elab-module! drop

    num-errors@ 0 > if(
        num-errors@ int-trace!
        " errors." caststr str-trace-ln!
        1 posix-exit!,

        id
    )

    "Done." caststr str-trace-ln!)

def(main, +IO,
    init!

    # argc int-trace-ln!
    # 0 while(dup argc <,
    #     dup argv ptr@@ str-trace-ln!
    #     1+
    # ) drop

    1 argc < if(
        1 argv ptr@@ Ptr->Str Str->Path compile!,
        "Expected at least one argument" caststr panic!)


    )

#########
# Build #
#########

target-c99("mirth.c", main)
